name: F1 Data Sync

on:
  # Run automatically twice daily at 6 AM and 6 PM UTC
  schedule:
    - cron: '0 6,18 * * *'
  
  # Allow manual triggering with options
  workflow_dispatch:
    inputs:
      year:
        description: 'Season year to ingest'
        required: false
        default: '2026'
        type: string
      skip_schedule:
        description: 'Skip schedule ingestion'
        required: false
        type: boolean
        default: false
      skip_results:
        description: 'Skip results ingestion'
        required: false
        type: boolean
        default: false

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        working-directory: ./worker
        run: |
          uv pip install --system -r requirements.txt
      
      - name: Sync F1 data
        working-directory: ./worker
        env:
          FASTF1_CACHE_DIR: ./cache/fastf1
        run: |
          # Convert DATABASE_URL to use asyncpg driver
          DB_URL="${{ secrets.DATABASE_URL }}"
          # Replace postgresql:// with postgresql+asyncpg://
          export DATABASE_URL="${DB_URL/postgresql:\/\//postgresql+asyncpg:\/\/}"
          
          # Build command with optional flags
          CMD="python ingest_all.py"
          
          # Add year (use input if manual trigger, otherwise 2026)
          if [ -n "${{ github.event.inputs.year }}" ]; then
            CMD="$CMD --year ${{ github.event.inputs.year }}"
          else
            CMD="$CMD --year 2026"
          fi
          
          # Add flags based on manual inputs
          if [ "${{ github.event.inputs.skip_schedule }}" = "true" ]; then
            CMD="$CMD --skip-schedule"
          fi
          
          if [ "${{ github.event.inputs.skip_results }}" = "true" ]; then
            CMD="$CMD --skip-results"
          fi
          
          echo "Running: $CMD"
          $CMD
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: sync-logs-${{ github.run_number }}
          path: worker/logs/
          retention-days: 7
